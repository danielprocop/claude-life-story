name: Deploy Monitor

on:
  workflow_run:
    workflows: ["Deploy to AWS"]
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  open-failure-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on deploy failure
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const title = `[CI] Deploy to AWS failed (${run.head_branch})`;
            const body = [
              `Workflow run failed.`,
              ``,
              `- workflow: ${run.name}`,
              `- branch: ${run.head_branch}`,
              `- commit: ${run.head_sha}`,
              `- run id: ${run.id}`,
              `- url: ${run.html_url}`,
              ``,
              `Generated automatically by deploy-alert workflow.`
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find(issue => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              });
              core.info(`Updated existing issue #${existing.number}`);
              return;
            }

            const created = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci', 'deploy', 'incident']
            });
            core.info(`Created issue #${created.data.number}`);
