<section class="search-page">
  <header class="page-header">
    <p class="eyebrow">Retrieval</p>
    <h2>Ricerca nella memoria personale</h2>
    <p class="page-subtitle">
      Cerca entry, entita canoniche, concetti e obiettivi del tuo profilo personale.
    </p>
  </header>

  <form class="search-bar" (ngSubmit)="submit()">
    <input
      [ngModel]="query()"
      (ngModelChange)="query.set($event)"
      name="query"
      type="search"
      placeholder="Cerca progetto, persona, problema, idea..."
    />
    <button type="submit" [disabled]="loading()">
      {{ loading() ? 'Ricerca...' : 'Cerca' }}
    </button>
  </form>

  @if (!hasSearched()) {
    <section class="empty-state">
      <h3>Nessuna query eseguita</h3>
      <p>Prova con nomi di persone, obiettivi, problemi ricorrenti o frasi contenute nelle entry.</p>
    </section>
  } @else if (loading()) {
    <section class="empty-state">
      <h3>Ricerca in corso</h3>
      <p>Sto interrogando il tuo dataset personale.</p>
    </section>
  } @else if (totalResults() === 0) {
    <section class="empty-state">
      <h3>Nessun risultato</h3>
      <p>Non ho trovato corrispondenze per "{{ query() }}".</p>
    </section>
  } @else {
    <section class="result-summary">
      <strong>{{ totalResults() }}</strong> risultati per <span>"{{ results()?.query }}"</span>
    </section>

    @if (results()?.entities?.length) {
      <section class="result-section">
        <div class="section-header">
          <h3>Entita canoniche</h3>
          <span>{{ filteredEntities().length }}</span>
        </div>

        <div class="entity-filters">
          @for (kind of entityFilters(); track kind.kind) {
            <button
              type="button"
              class="kind-filter"
              [attr.data-active]="selectedEntityKind() === kind.kind"
              (click)="setEntityKind(kind.kind)">
              {{ kind.kind }}: {{ kind.count }}
            </button>
          }
        </div>

        @if (!filteredEntities().length) {
          <p class="result-meta">Nessuna entita per il tipo selezionato.</p>
        } @else {
          <div class="result-grid">
            @for (entity of filteredEntities(); track entity.id) {
              <article class="result-card entity-card">
                <p class="pill">{{ entity.kind }}</p>
                <h4>{{ entity.canonicalName }}</h4>
                @if (entity.resolutionState && entity.resolutionState !== 'normal') {
                  <p class="result-meta">Stato: {{ entity.resolutionState }}</p>
                }
                @if (entity.anchorKey) {
                  <p class="result-meta">Anchor: {{ entity.anchorKey }}</p>
                }
                @if (entity.aliases.length) {
                  <p class="result-text">Alias: {{ entity.aliases.join(', ') }}</p>
                }
                <p class="result-meta">
                  {{ entity.evidenceCount }} evidenze 路 aggiornato {{ entity.updatedAt | date:'dd MMM yyyy, HH:mm' }}
                </p>
                <a [routerLink]="['/nodes', entity.id]">Apri nodo</a>
              </article>
            }
          </div>
        }
      </section>
    }

    @if (results()?.entries?.length) {
      <section class="result-section">
        <div class="section-header">
          <h3>Entry</h3>
          <span>{{ results()!.entries.length }}</span>
        </div>

        <div class="result-grid">
          @for (entry of results()!.entries; track entry.id) {
            <article class="result-card">
              <p class="result-meta">{{ entry.createdAt | date:'dd MMM yyyy, HH:mm' }} 路 {{ entry.conceptCount }} concetti</p>
              <p class="result-text">{{ entry.preview }}</p>
              <a [routerLink]="['/entries', entry.id]">Apri entry</a>
            </article>
          }
        </div>
      </section>
    }

    @if (results()?.concepts?.length) {
      <section class="result-section">
        <div class="section-header">
          <h3>Concetti</h3>
          <span>{{ results()!.concepts.length }}</span>
        </div>

        <div class="result-grid compact">
          @for (concept of results()!.concepts; track concept.id) {
            <article class="result-card concept-card">
              <p class="pill">{{ concept.type }}</p>
              <h4>{{ concept.label }}</h4>
              <p class="result-meta">Usato in {{ concept.entryCount }} entry 路 ultimo uso {{ concept.lastSeenAt | date:'dd MMM yyyy' }}</p>
            </article>
          }
        </div>
      </section>
    }

    @if (results()?.goalItems?.length) {
      <section class="result-section">
        <div class="section-header">
          <h3>Goal</h3>
          <span>{{ results()!.goalItems.length }}</span>
        </div>

        <div class="result-grid">
          @for (goal of results()!.goalItems; track goal.id) {
            <article class="result-card goal-card">
              <div class="goal-head">
                <h4>{{ goal.title }}</h4>
                <span class="goal-status" [attr.data-status]="goal.status">{{ goal.status }}</span>
              </div>
              @if (goal.description) {
                <p class="result-text">{{ goal.description }}</p>
              }
              <p class="result-meta">{{ goal.subGoalCount }} sotto-step 路 creato {{ goal.createdAt | date:'dd MMM yyyy' }}</p>
              <a [routerLink]="['/goals']">Apri obiettivi</a>
            </article>
          }
        </div>
      </section>
    }
  }
</section>
