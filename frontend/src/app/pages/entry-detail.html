<section class="entry-detail-page">
  <a class="back-link" routerLink="/timeline">← Torna alla timeline</a>

  @if (loading()) {
    <div class="state-card">Caricamento entry...</div>
  } @else if (error()) {
    <div class="state-card error">{{ error() }}</div>
  } @else if (entry(); as e) {
    <article class="entry-card">
      <header class="entry-header">
        <div>
          <p class="entry-date">{{ e.createdAt | date:'dd MMM yyyy, HH:mm' }}</p>
          @if (e.updatedAt) {
            <p class="entry-updated">Aggiornata {{ e.updatedAt | date:'dd MMM yyyy, HH:mm' }}</p>
          }
        </div>

        <div class="entry-actions">
          @if (!editing()) {
            <button type="button" class="secondary-button" (click)="startEditing()">Modifica</button>
          }
          <button type="button" class="danger-button" (click)="deleteEntry()" [disabled]="deleting() || saving()">
            {{ deleting() ? 'Eliminazione...' : 'Elimina' }}
          </button>
        </div>
      </header>

      @if (statusMessage()) {
        <div class="status-banner">{{ statusMessage() }}</div>
      }

      @if (editing()) {
        <section class="editor-section">
          <label class="editor-label" for="entry-content">Contenuto</label>
          <textarea
            id="entry-content"
            class="editor-input"
            [ngModel]="draftContent()"
            (ngModelChange)="draftContent.set($event)"
            rows="10"></textarea>
          <p class="editor-note">
            Le connessioni, i concetti e gli insight verranno ricalcolati in background per mantenere la memoria coerente.
          </p>
          <div class="editor-actions">
            <button
              type="button"
              class="primary-button"
              (click)="save()"
              [disabled]="saving() || !draftContent().trim()">
              {{ saving() ? 'Salvataggio...' : 'Salva modifica' }}
            </button>
            <button type="button" class="secondary-button" (click)="cancelEditing()" [disabled]="saving()">
              Annulla
            </button>
          </div>
        </section>
      } @else {
        <div class="entry-content">{{ e.content }}</div>
      }

      @if (e.concepts?.length) {
        <section class="concepts-section">
          <h3>Concetti estratti</h3>
          <div class="concept-grid">
            @for (concept of e.concepts!; track concept.id) {
              <div class="concept-pill">
                <span class="concept-type">{{ concept.type }}</span>
                <strong>{{ concept.label }}</strong>
                <button type="button" class="pill-feedback-button" (click)="setFeedbackFromConcept(concept)">
                  Correggi
                </button>
              </div>
            }
          </div>
        </section>
      } @else if (statusMessage()) {
        <section class="concepts-section">
          <h3>Ricalcolo in corso</h3>
          <p class="empty-state">
            I dati derivati di questa entry verranno ricostruiti automaticamente a partire dal nuovo contenuto.
          </p>
        </section>
      }

      <section class="feedback-section">
        <h3>Correggi estrazione AI</h3>
        <p class="empty-state">
          Segnala un termine classificato male (esempio: "Milan" squadra, non persona). La regola verra riusata nelle prossime elaborazioni.
        </p>
        <div class="feedback-grid">
          <label>
            Termine
            <input
              type="text"
              class="feedback-input"
              [ngModel]="feedbackTerm()"
              (ngModelChange)="feedbackTerm.set($event)"
              placeholder="Es: Milan" />
          </label>
          <label>
            Tipo corretto
            <select
              class="feedback-input"
              [ngModel]="feedbackKind()"
              (ngModelChange)="feedbackKind.set($event)">
              <option value="person">Persona</option>
              <option value="place">Luogo</option>
              <option value="team">Team/Squadra</option>
              <option value="organization">Organizzazione</option>
              <option value="project">Progetto</option>
              <option value="activity">Attivita</option>
              <option value="emotion">Emozione</option>
              <option value="idea">Idea</option>
              <option value="problem">Problema</option>
              <option value="finance">Finanza</option>
              <option value="not_person">Non e una persona</option>
            </select>
          </label>
        </div>
        <label class="feedback-note-label">
          Nota (opzionale)
          <textarea
            rows="3"
            class="feedback-input"
            [ngModel]="feedbackNote()"
            (ngModelChange)="feedbackNote.set($event)"
            placeholder="Dettagli utili per il contesto"></textarea>
        </label>
        <button
          type="button"
          class="primary-button"
          (click)="sendEntityFeedback()"
          [disabled]="feedbackSubmitting() || !feedbackTerm().trim()">
          {{ feedbackSubmitting() ? 'Invio...' : 'Invia feedback' }}
        </button>
      </section>

      @if (relatedEntries().length > 0) {
        <section class="related-section">
          <h3>Entry correlate</h3>
          <div class="related-list">
            @for (related of relatedEntries(); track related.id) {
              <article class="related-card">
                <p class="related-meta">
                  {{ related.createdAt | date:'dd MMM yyyy, HH:mm' }} · {{ related.sharedConceptCount }} concetti in comune
                </p>
                <p class="related-preview">{{ related.contentPreview }}</p>
                <a [routerLink]="['/entries', related.id]">Apri entry correlata</a>
              </article>
            }
          </div>
        </section>
      }
    </article>
  }
</section>
