<div class="timeline-page">
  <header class="timeline-header">
    <div>
      <h2 class="page-title">Timeline</h2>
      <p class="page-subtitle">Esplora la tua storia per giorno, settimana, mese o anno.</p>
    </div>
    <div class="view-switch">
      @for (mode of availableViews; track mode) {
        <button
          type="button"
          [class.active]="view() === mode"
          (click)="setView(mode)"
          [disabled]="loading()">
          @if (mode === 'day') { Giorno }
          @else if (mode === 'week') { Settimana }
          @else if (mode === 'month') { Mese }
          @else { Anno }
        </button>
      }
    </div>
  </header>

  @if (notice()) {
    <div class="notice-banner">{{ notice() }}</div>
  }

  @if (loading()) {
    <div class="state-card">Caricamento timeline...</div>
  } @else if (error()) {
    <div class="state-card error">{{ error() }}</div>
  } @else if (!timeline() || timeline()!.buckets.length === 0) {
    <div class="state-card empty">Nessuna entry ancora. Vai a scrivere qualcosa!</div>
  } @else {
    <div class="timeline-controls">
      <div class="timeline-meta-row">
        <div class="timeline-meta">
          <span class="window-label">{{ windowLabel() }}</span>
          <span class="window-count">{{ windowEntriesCount() }} entry visibili</span>
        </div>
        <button type="button" class="focus-current-btn" (click)="centerOnCurrentPeriod()">
          Vai al periodo attuale
        </button>
      </div>

      @if (overviewBuckets().length > 0) {
        <div class="timeline-overview">
          <div class="overview-head">
            <span>Panoramica periodi caricati</span>
            <span>{{ overviewBuckets().length }} blocchi</span>
          </div>
          <div class="overview-strip" role="list" aria-label="Panoramica timeline">
            @for (point of overviewBuckets(); track point.bucketKey) {
              <button
                type="button"
                class="overview-bucket"
                [class.active]="point.isActive"
                [class.current]="point.isCurrent"
                [class.empty]="point.entryCount === 0"
                [attr.aria-label]="'Vai a ' + point.label + ', ' + point.entryCount + ' entry'"
                [title]="point.label + ' • ' + point.entryCount + ' entry'"
                (click)="jumpToOverviewBucket(point.index)">
                <span class="overview-fill" [style.height.%]="point.heightPercent"></span>
              </button>
            }
          </div>
        </div>
      }
    </div>

    <div class="timeline-scroll-wrap">
      @if (scrollLeftVisible()) {
        <button type="button" class="scroll-arrow left" (click)="scrollTimeline('left')" aria-label="Scorri a sinistra">
          ←
        </button>
      }
      @if (scrollRightVisible()) {
        <button type="button" class="scroll-arrow right" (click)="scrollTimeline('right')" aria-label="Scorri a destra">
          →
        </button>
      }

      <div class="timeline-scroll" #timelineScrollEl (scroll)="onTimelineScrolled()">
        <div class="timeline-spacer" aria-hidden="true"></div>
        @for (bucket of timeline()!.buckets; track bucket.bucketKey) {
          <section class="timeline-bucket" [attr.data-bucket-key]="bucket.bucketKey">
            <header class="bucket-header">
              <h3>{{ bucket.label }}</h3>
              <span>{{ bucket.entryCount }}</span>
            </header>

            @if (bucket.entries.length === 0) {
              <p class="bucket-empty">Nessuna entry in questo periodo.</p>
            } @else {
              <div class="bucket-cards">
                @for (entry of bucket.entries; track entry.id) {
                  <article class="entry-card">
                    <p class="entry-date">{{ entry.createdAt | date:'dd MMM yyyy, HH:mm' }}</p>
                    <p class="entry-content">{{ entry.contentPreview }}</p>
                    <div class="entry-footer">
                      <span class="entry-meta">{{ formatEntryMeta(entry) }}</span>
                      <a [routerLink]="['/entries', entry.id]">Apri</a>
                    </div>
                  </article>
                }
              </div>
            }

            @if (bucket.hasMoreEntries) {
              <p class="bucket-more">Mostrate {{ bucket.entries.length }} di {{ bucket.entryCount }} entry.</p>
            }
          </section>
        }
        <div class="timeline-spacer" aria-hidden="true"></div>
      </div>

      <div class="scroll-status">
        <p class="scroll-hint" [class.hidden]="!(scrollLeftVisible() || scrollRightVisible())">
          Scorri orizzontalmente: il range si estende automaticamente.
        </p>
        <p class="scroll-loading" [class.hidden]="!(loadingMorePrevious() || loadingMoreNext())">
          Caricamento altri periodi...
        </p>
      </div>
    </div>
  }
</div>
