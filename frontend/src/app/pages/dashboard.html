<div class="dashboard-page">
  <h2>Dashboard</h2>

  @if (loading()) {
    <p class="loading">Caricamento...</p>
  } @else if (data(); as d) {
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value">{{ d.stats.totalEntries }}</span>
        <span class="stat-label">Entry totali</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ d.stats.totalConcepts }}</span>
        <span class="stat-label">Concetti estratti</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ d.stats.activeGoals }}</span>
        <span class="stat-label">Obiettivi attivi</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ d.stats.insightsGenerated }}</span>
        <span class="stat-label">Insight generati</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" [style.color]="getEnergyColor(d.stats.avgEnergy)">{{ d.stats.avgEnergy }}</span>
        <span class="stat-label">Energia media</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" [style.color]="getStressColor(d.stats.avgStress)">{{ d.stats.avgStress }}</span>
        <span class="stat-label">Stress medio</span>
      </div>
    </div>

    <div class="brain-strip">
      @if (profileLoading()) {
        <article class="card brain-card">
          <h3>Modello personale</h3>
          <p class="empty">Aggiornamento contesto in corso...</p>
        </article>
      } @else if (profile(); as p) {
        <article class="card brain-card">
          <h3>Modello personale</h3>
          <p class="brain-summary">{{ p.contextSummary }}</p>
          @if (p.personalitySignals.length) {
            <div class="brain-tags">
              @for (signal of p.personalitySignals; track signal.trait) {
                <span class="brain-tag">{{ signal.trait }} ({{ signal.score }})</span>
              }
            </div>
          }
          @if (p.currentFocus.length) {
            <ul class="brain-list">
              @for (focus of p.currentFocus; track focus) {
                <li>{{ focus }}</li>
              }
            </ul>
          }
          <a routerLink="/graph">Apri mappa cognitiva</a>
        </article>

        <article class="card brain-card">
          <h3>Prossimi micro-step</h3>
          @if (p.suggestedMicroSteps.length) {
            <ul class="brain-list">
              @for (step of p.suggestedMicroSteps; track step) {
                <li>{{ step }}</li>
              }
            </ul>
          } @else {
            <p class="empty">Nessuno step suggerito al momento.</p>
          }
        </article>
      }
    </div>

    <div class="dashboard-grid">
      <div class="card full-width operations-card">
        <h3>Operazioni memoria</h3>
        <p class="empty">
          Usa questi comandi quando cambi algoritmo di mapping o vuoi riallineare mappa e retrieval.
        </p>
        <div class="ops-guide">
          <span><strong>Normalize Entities:</strong> fix duplicati place/person senza rebuild completo.</span>
          <span><strong>Reindex Entities:</strong> solo riallineamento indice OpenSearch (light).</span>
          <span><strong>Rebuild + Reindex:</strong> heavy, solo dopo cambi profondi ingestione.</span>
          <span><strong>Search Health/Bootstrap:</strong> verifica e crea indici OpenSearch mancanti.</span>
          <span><strong>Cleanup Legacy Feedback:</strong> rimuove vecchie policy entry-level non piu usate.</span>
        </div>
        <div class="ops-actions">
          <button type="button" (click)="runNormalizeEntities()" [disabled]="operationsBusy()">Normalize Entities</button>
          <button type="button" (click)="runRebuildMemory()" [disabled]="operationsBusy()">Rebuild Memory</button>
          <button type="button" (click)="runReindexEntities()" [disabled]="operationsBusy()">Reindex Entities</button>
          <button type="button" (click)="runRebuildAndReindex()" [disabled]="operationsBusy()">Rebuild + Reindex</button>
          <button type="button" (click)="runSearchHealth()" [disabled]="operationsBusy()">Search Health</button>
          <button type="button" (click)="runSearchBootstrap()" [disabled]="operationsBusy()">Search Bootstrap</button>
          <button type="button" (click)="runLegacyFeedbackCleanup()" [disabled]="operationsBusy()">Cleanup Legacy Feedback</button>
        </div>
        @if (operationsMessage()) {
          <p class="ops-status">{{ operationsMessage() }}</p>
        }
        @if (searchHealth(); as health) {
          <p class="ops-status">
            Search enabled={{ health.enabled }} · ping={{ health.pingOk }} · entityIndex={{ health.entityIndexExists }}
            · entryIndex={{ health.entryIndexExists }} · goalIndex={{ health.goalIndexExists }}
          </p>
        }
      </div>

      <div class="card">
        <h3>Debiti aperti</h3>
        @if (openDebts().length) {
          @for (debt of openDebts(); track debt.counterpartyEntityId) {
            <div class="goal-item">
              <span class="goal-title">{{ debt.counterpartyName }}</span>
              <span class="goal-desc">{{ debt.amountOpen }} {{ debt.currency }} · {{ debt.openItems }} movimenti</span>
            </div>
          }
        } @else {
          <p class="empty">Nessun debito aperto.</p>
        }
      </div>

      <div class="card">
        <h3>Domande rapide</h3>
        @if (questions().length) {
          @for (question of questions(); track question.id) {
            <div class="insight-item">
              <span class="insight-type" data-type="question">{{ question.questionType }}</span>
              <p>{{ question.prompt }}</p>
              <div class="question-actions">
                <button type="button" (click)="answerQuestion(question.id, 'si, split uguale')" [disabled]="answeringQuestions()[question.id]">
                  Split uguale
                </button>
                <button type="button" (click)="answerQuestion(question.id, 'no')" [disabled]="answeringQuestions()[question.id]">
                  No
                </button>
              </div>
              <div class="question-input">
                <input
                  type="text"
                  placeholder="Oppure inserisci risposta libera"
                  [value]="questionDrafts()[question.id] ?? ''"
                  (input)="setQuestionDraft(question.id, $any($event.target).value)"
                />
                <button type="button" (click)="answerQuestion(question.id)" [disabled]="answeringQuestions()[question.id]">
                  Invia
                </button>
              </div>
            </div>
          }
        } @else {
          <p class="empty">Nessuna domanda aperta.</p>
        }
      </div>

      <div class="card">
        <h3>Energia / Stress (ultimi 14 giorni)</h3>
        @if (d.energyTrend.length > 0) {
          <div class="energy-bars">
            @for (point of d.energyTrend; track point.date) {
              <div class="energy-bar-group">
                <div class="bar-container">
                  <div class="bar energy-bar" [style.height.%]="point.energy * 10" [style.background]="getEnergyColor(point.energy)"></div>
                  <div class="bar stress-bar" [style.height.%]="point.stress * 10" [style.background]="getStressColor(point.stress)"></div>
                </div>
                <span class="bar-date">{{ point.date | date:'dd/MM' }}</span>
              </div>
            }
          </div>
          <div class="legend">
            <span class="legend-item"><span class="dot" style="background:#22c55e"></span> Energia</span>
            <span class="legend-item"><span class="dot" style="background:#ef4444"></span> Stress</span>
          </div>
        } @else {
          <p class="empty">Nessun dato energia ancora disponibile.</p>
        }
      </div>

      <div class="card">
        <h3>Concetti principali</h3>
        @if (d.topConcepts.length > 0) {
          <div class="concept-list">
            @for (c of d.topConcepts; track c.id) {
              <div class="concept-item">
                <span class="concept-label">{{ c.label }}</span>
                <span class="concept-badge" [attr.data-type]="c.type">{{ c.type }}</span>
                <span class="concept-count">{{ c.entryCount }}x</span>
              </div>
            }
          </div>
        } @else {
          <p class="empty">Nessun concetto estratto.</p>
        }
      </div>

      <div class="card">
        <h3>Obiettivi attivi</h3>
        @if (d.activeGoals.length > 0) {
          @for (g of d.activeGoals; track g.id) {
            <div class="goal-item">
              <span class="goal-title">{{ g.title }}</span>
              @if (g.description) {
                <span class="goal-desc">{{ g.description }}</span>
              }
            </div>
          }
        } @else {
          <p class="empty">Nessun obiettivo attivo. <a routerLink="/goals">Crea un obiettivo</a></p>
        }
      </div>

      <div class="card">
        <h3>Insight recenti</h3>
        @if (d.recentInsights.length > 0) {
          @for (i of d.recentInsights; track i.id) {
            <div class="insight-item">
              <span class="insight-type" [attr.data-type]="i.type">{{ i.type }}</span>
              <p>{{ i.content }}</p>
            </div>
          }
        } @else {
          <p class="empty">Nessun insight ancora. Scrivi alcune entry per generarli.</p>
        }
      </div>

      <div class="card full-width">
        <h3>Entry recenti</h3>
        @if (d.recentEntries.length > 0) {
          @for (e of d.recentEntries; track e.id) {
            <div class="entry-item">
              <span class="entry-date">{{ e.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
              <p>{{ e.contentPreview }}</p>
            </div>
          }
        } @else {
          <p class="empty">Nessuna entry. <a routerLink="/write">Scrivi la prima!</a></p>
        }
      </div>
    </div>
  }
</div>
