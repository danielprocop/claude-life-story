<div class="graph-page">
  <div class="graph-header">
    <div>
      <h2 class="page-title">Mappa Cognitiva</h2>
      <p class="page-subtitle">Nodi canonici personali: persone, eventi, alias, evidence e relazioni forti.</p>
    </div>
    @if (response()) {
      <div class="graph-stats">
        <div class="stat">
          <span class="stat-value">{{ response()!.items.length }}</span>
          <span class="stat-label">Nodi</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ response()!.totalCount }}</span>
          <span class="stat-label">Totali</span>
        </div>
      </div>
    }
  </div>

  <form class="filter-bar" (ngSubmit)="submit()">
    <input
      [ngModel]="query()"
      (ngModelChange)="query.set($event)"
      name="query"
      type="search"
      placeholder="Filtra nodi per nome, alias o anchor..."
    />
    <button type="submit" [disabled]="loading()">{{ loading() ? 'Caricamento...' : 'Filtra' }}</button>
  </form>

  @if (loading()) {
    <div class="loading">Caricamento nodi...</div>
  } @else if (!response() || response()!.items.length === 0) {
    <div class="empty">Nessun nodo trovato. Inserisci nuove entry per costruire la memoria canonica.</div>
  } @else {
    <section class="kind-summary">
      @for (item of groupedByKind() | keyvalue; track item.key) {
        <div class="kind-pill">{{ item.key }}: {{ item.value }}</div>
      }
    </section>

    <section class="node-grid">
      @for (node of response()!.items; track node.id) {
        <article class="node-card">
          <p class="pill">{{ node.kind }}</p>
          <h3>{{ node.canonicalName }}</h3>
          @if (node.anchorKey) {
            <p class="meta">Anchor: {{ node.anchorKey }}</p>
          }
          @if (node.aliases.length) {
            <p class="aliases">{{ node.aliases.join(', ') }}</p>
          }
          <p class="meta">
            {{ node.evidenceCount }} evidenze Â· aggiornato {{ node.updatedAt | date:'dd MMM yyyy, HH:mm' }}
          </p>
          <a [routerLink]="['/nodes', node.id]">Apri nodo</a>
        </article>
      }
    </section>
  }
</div>
