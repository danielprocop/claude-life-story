<section class="feedback-admin-page">
  <header class="page-header">
    <div>
      <h2>Feedback Admin</h2>
      <p>Workflow template-based: review queue -> preview -> apply -> replay.</p>
    </div>
    <button type="button" class="secondary-button" (click)="reload()">Aggiorna</button>
  </header>

  @if (loading()) {
    <article class="card">Caricamento feedback system...</article>
  } @else {
    @if (error()) {
      <article class="card error">{{ error() }}</article>
    }
    @if (feedbackStatus()) {
      <article class="card status">{{ feedbackStatus() }}</article>
    }
    @if (hasReplayFailures()) {
      <article class="card error">
        Sono presenti replay job in stato failed. Controlla sezione "Replay jobs" e correggi prima di nuovi apply massivi.
      </article>
    }

    <article class="card">
      <h3>Policy state</h3>
      <div class="stats-grid">
        <div class="stat">
          <span>Policy version</span>
          <strong>{{ policyVersion()?.policyVersion ?? '-' }}</strong>
        </div>
        <div class="stat">
          <span>Global actions</span>
          <strong>{{ policySummary()?.globalActions ?? '-' }}</strong>
        </div>
        <div class="stat">
          <span>User actions</span>
          <strong>{{ policySummary()?.userActions ?? '-' }}</strong>
        </div>
        <div class="stat">
          <span>Redirects</span>
          <strong>{{ policySummary()?.redirects ?? '-' }}</strong>
        </div>
      </div>
    </article>

    <article class="card">
      <h3>Assist template</h3>
      <div class="form-row">
        <input
          type="text"
          [ngModel]="assistText()"
          (ngModelChange)="assistText.set($event)"
          placeholder='Es: "blocca inoltre come persona"' />
        <button type="button" class="secondary-button" (click)="assistTemplate()" [disabled]="assistLoading()">
          {{ assistLoading() ? 'Analisi...' : 'Precompila' }}
        </button>
      </div>
    </article>

    <article class="card">
      <h3>Preview / Apply</h3>
      <p class="hint">
        <strong>Preview</strong> simula (non salva). <strong>Apply</strong> salva le actions in Aurora, incrementa la policy
        e avvia un replay/backfill mirato.
      </p>
      <p class="hint">
        Consiglio: per correzioni su un nodo specifico, usa la pagina del nodo (meno errori). Qui e utile per regole globali
        o operazioni avanzate.
      </p>

      <div class="mode-toggle">
        <button type="button" class="secondary-button" [class.active]="editMode() === 'wizard'" (click)="editMode.set('wizard')">
          Guidato
        </button>
        <button type="button" class="secondary-button" [class.active]="editMode() === 'json'" (click)="editMode.set('json')">
          JSON
        </button>
      </div>

      <div class="form-grid">
        <label>
          Template
          <select [ngModel]="selectedTemplate()" (ngModelChange)="selectedTemplate.set($event)">
            <option value="T4">T4 - Change entity type</option>
            <option value="T5">T5 - Add/Remove alias</option>
            <option value="T6">T6 - Force link rule</option>
            <option value="T1">T1 - Block token global</option>
            <option value="T2">T2 - Token type override global</option>
          </select>
        </label>
        <label>
          Reason
          <input type="text" [ngModel]="reason()" (ngModelChange)="reason.set($event)" placeholder="Motivo del feedback" />
        </label>
      </div>

      @if (editMode() === 'wizard') {
        @if (selectedTemplate() === 'T1' || selectedTemplate() === 'T2') {
          <div class="form-grid">
            <label>
              Token
              <input
                type="text"
                [ngModel]="wizardToken()"
                (ngModelChange)="wizardToken.set($event)"
                placeholder='Es. "inoltre" o "lei"' />
              <small class="hint">Usa per stopword/pronomi/connector che non devono diventare entita.</small>
            </label>

            @if (selectedTemplate() === 'T1') {
              <label>
                Applies to
                <select [ngModel]="wizardAppliesTo()" (ngModelChange)="wizardAppliesTo.set($event)">
                  <option value="ANY">ANY</option>
                  <option value="PERSON">PERSON</option>
                  <option value="GOAL">GOAL</option>
                </select>
                <small class="hint">PERSON e piu sicuro. ANY e piu aggressivo.</small>
              </label>
              <label>
                Classification
                <select [ngModel]="wizardClassification()" (ngModelChange)="wizardClassification.set($event)">
                  <option value="CONNECTIVE">CONNECTIVE</option>
                  <option value="STOPWORD">STOPWORD</option>
                  <option value="OTHER">OTHER</option>
                </select>
              </label>
            }

            @if (selectedTemplate() === 'T2') {
              <label>
                Forced type
                <select [ngModel]="wizardForcedTokenType()" (ngModelChange)="wizardForcedTokenType.set($event)">
                  <option value="STOPWORD">STOPWORD</option>
                  <option value="CONNECTIVE">CONNECTIVE</option>
                  <option value="ROLE_TRIGGER">ROLE_TRIGGER</option>
                  <option value="TEMPORAL">TEMPORAL</option>
                  <option value="OTHER">OTHER</option>
                </select>
              </label>
            }
          </div>
        }

        @if (selectedTemplate() === 'T4' || selectedTemplate() === 'T5' || selectedTemplate() === 'T6') {
          <div class="form-row">
            <input
              type="text"
              [ngModel]="wizardEntityQuery()"
              (ngModelChange)="wizardEntityQuery.set($event)"
              placeholder="Cerca entita (es. Irina)"
              (blur)="searchWizardEntities()" />
            <button type="button" class="secondary-button" (click)="searchWizardEntities()" [disabled]="wizardEntitySearchLoading()">
              {{ wizardEntitySearchLoading() ? 'Ricerca...' : 'Cerca' }}
            </button>
          </div>
          @if (wizardEntityId()) {
            <p class="hint">Entity selezionata: <strong>{{ wizardEntityId() }}</strong></p>
          }
          @if (wizardEntityResults().length) {
            <div class="entity-results">
              @for (entity of wizardEntityResults(); track entity.id) {
                <button type="button" class="entity-item" (click)="selectWizardEntity(entity)">
                  {{ entity.canonicalName }} · {{ entity.kind }}
                </button>
              }
            </div>
          }

          @if (selectedTemplate() === 'T4') {
            <div class="form-grid">
              <label>
                New type
                <input type="text" [ngModel]="wizardNewType()" (ngModelChange)="wizardNewType.set($event)" placeholder="Es. place" />
                <small class="hint">Tipi comuni: person, place, goal, idea, organization, team, project, activity.</small>
              </label>
            </div>
          }

          @if (selectedTemplate() === 'T5') {
            <div class="form-grid">
              <label>
                Alias
                <input type="text" [ngModel]="wizardAlias()" (ngModelChange)="wizardAlias.set($event)" placeholder="Es. Felia" />
              </label>
              <label>
                Op
                <select [ngModel]="wizardAliasOp()" (ngModelChange)="wizardAliasOp.set($event)">
                  <option value="ADD">ADD</option>
                  <option value="REMOVE">REMOVE</option>
                </select>
              </label>
            </div>
          }

          @if (selectedTemplate() === 'T6') {
            <div class="form-grid">
              <label>
                Pattern kind
                <select [ngModel]="wizardPatternKind()" (ngModelChange)="wizardPatternKind.set($event)">
                  <option value="EXACT">EXACT</option>
                  <option value="NORMALIZED">NORMALIZED</option>
                  <option value="REGEX">REGEX</option>
                </select>
              </label>
              <label>
                Pattern value
                <input type="text" [ngModel]="wizardPatternValue()" (ngModelChange)="wizardPatternValue.set($event)" placeholder="Es. mia madre" />
              </label>
              <label>
                Near tokens (csv, opzionale)
                <input type="text" [ngModel]="wizardNearTokens()" (ngModelChange)="wizardNearTokens.set($event)" placeholder="es. mamma,famiglia" />
              </label>
              <label>
                Within chars (opzionale)
                <input type="number" [ngModel]="wizardWithinChars()" (ngModelChange)="wizardWithinChars.set($event ? +$event : null)" />
              </label>
            </div>
          }
        }

        <label class="payload-label">
          Payload (auto-generato)
          <pre class="code-block">{{ wizardPayloadPreview() }}</pre>
        </label>
      } @else {
        <label class="payload-label">
          Payload JSON
          <textarea
            rows="10"
            [ngModel]="payloadText()"
            (ngModelChange)="payloadText.set($event)"
            placeholder='{"entity_id":"..."}'></textarea>
        </label>
      }
      <div class="actions">
        <button type="button" class="secondary-button" (click)="previewCase()" [disabled]="previewLoading() || applyLoading()">
          {{ previewLoading() ? 'Preview...' : 'Preview' }}
        </button>
        <button type="button" class="primary-button" (click)="applyCase()" [disabled]="applyLoading() || previewLoading()">
          {{ applyLoading() ? 'Apply...' : 'Apply' }}
        </button>
      </div>

      @if (previewResult(); as preview) {
        <article class="sub-card">
          <h4>Impact preview</h4>
          <p>
            Entita impattate: {{ preview.impactSummary.impactedEntities }} ·
            Mentions: {{ preview.impactSummary.mentionLinkChangesEstimate }} ·
            Entries replay: {{ preview.impactSummary.entriesToReplay }}
          </p>
          @if (preview.warnings.length) {
            <ul class="inline-list">
              @for (warning of preview.warnings; track warning) {
                <li>{{ warning }}</li>
              }
            </ul>
          }
          @if (preview.parsedActions.length) {
            <p class="hint"><strong>Actions</strong>: modifiche atomiche che verranno persistite (policy) e usate dal compiler.</p>
            <div class="queue-list">
              @for (action of preview.parsedActions; track action.actionType + action.payloadJson) {
                <article class="queue-item">
                  <div>
                    <p class="meta">{{ action.actionType }} · scope {{ action.scope }}</p>
                    <pre class="code-block">{{ prettyJsonText(action.payloadJson) }}</pre>
                  </div>
                </article>
              }
            </div>
          }
        </article>
      }

      @if (applyResult(); as applied) {
        <article class="sub-card">
          <h4>Apply result</h4>
          <p>Case: {{ applied.caseId }}</p>
          <p>Policy version: {{ applied.policyVersion }}</p>
          <p>Replay job: {{ applied.replayJob.id }} ({{ applied.replayJob.status }})</p>
          @if (applied.appliedActions.length) {
            <p class="hint">Actions applicate:</p>
            <div class="queue-list">
              @for (action of applied.appliedActions; track action.actionType + action.payloadJson) {
                <article class="queue-item">
                  <div>
                    <p class="meta">{{ action.actionType }} · scope {{ action.scope }}</p>
                    <pre class="code-block">{{ prettyJsonText(action.payloadJson) }}</pre>
                  </div>
                </article>
              }
            </div>
          }
        </article>
      }
    </article>

    <article class="card">
      <h3>Review queue</h3>
      @if (reviewQueue().length) {
        <div class="queue-list">
          @for (item of reviewQueue(); track item.issueType + item.title + item.suggestedPayloadJson) {
            <article class="queue-item">
              <div>
                <p class="meta">{{ item.issueType }} · {{ item.severity }}</p>
                <strong>{{ item.title }}</strong>
                @if (item.evidenceSnippets.length) {
                  <p>{{ item.evidenceSnippets[0] }}</p>
                }
              </div>
              <button type="button" class="secondary-button" (click)="useQueueSuggestion(item)">Usa template</button>
            </article>
          }
        </div>
      } @else {
        <p class="empty">Review queue vuota.</p>
      }
    </article>

    <article class="card">
      <h3>Replay jobs</h3>
      @if (replayLoading()) {
        <p class="empty">Caricamento replay jobs...</p>
      } @else if (replayJobs().length) {
        <div class="queue-list">
          @for (job of replayJobs(); track job.id) {
            <article class="queue-item">
              <div>
                <p class="meta">
                  {{ job.id }} · policy {{ job.policyVersion }} · {{ job.createdAt | date:'dd MMM yyyy, HH:mm' }}
                </p>
                <strong>{{ job.status }}</strong>
                @if (job.error) {
                  <p>Errore: {{ job.error }}</p>
                }
              </div>
            </article>
          }
        </div>
      } @else {
        <p class="empty">Nessun replay job recente.</p>
      }
    </article>

    <article class="card">
      <h3>Case history</h3>
      @if (cases().length) {
        <div class="queue-list">
          @for (item of cases(); track item.id) {
            <article class="queue-item">
              <div>
                <p class="meta">{{ item.templateId }} · {{ item.status }} · {{ item.createdAt | date:'dd MMM yyyy, HH:mm' }}</p>
                <strong>{{ item.reason || 'Nessun reason' }}</strong>
              </div>
              @if (item.status === 'APPLIED') {
                <button type="button" class="danger-button" (click)="revertCase(item.id)">Revert</button>
              }
            </article>
          }
        </div>
      } @else {
        <p class="empty">Nessun feedback case ancora applicato.</p>
      }
    </article>

    <article class="card">
      <h3>Entity debug</h3>
      <div class="form-row">
        <input
          type="text"
          [ngModel]="entityQuery()"
          (ngModelChange)="entityQuery.set($event)"
          placeholder="Cerca entita"
          (blur)="searchEntities()" />
        <button type="button" class="secondary-button" (click)="searchEntities()" [disabled]="entitySearchLoading()">
          {{ entitySearchLoading() ? 'Ricerca...' : 'Cerca' }}
        </button>
      </div>
      @if (entityResults().length) {
        <div class="entity-results">
          @for (entity of entityResults(); track entity.id) {
            <button type="button" class="entity-item" (click)="loadEntityDebug(entity.id)">
              {{ entity.canonicalName }} · {{ entity.kind }}
            </button>
          }
        </div>
      }

      @if (entityDebugLoading()) {
        <p class="empty">Caricamento debug...</p>
      } @else if (entityDebug(); as debug) {
        <article class="sub-card">
          <h4>{{ debug.canonicalName }}</h4>
          <p>{{ debug.kind }} · {{ debug.resolutionState }}</p>
          @if (debug.why.length) {
            <ul class="inline-list">
              @for (item of debug.why; track item) {
                <li>{{ item }}</li>
              }
            </ul>
          }
        </article>
      }
    </article>
  }
</section>
